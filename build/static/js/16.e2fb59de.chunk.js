(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{749:function(e,t,a){"use strict";a.r(t);var s=a(26),n=a(14),c=a(17),o=a(16),i=a(15),r=a(18),l=a(0),m=a.n(l),u=a(22),h=a(38),d=a.n(h),p=a(441),g=function(e){return m.a.createElement(p.a,{to:"".concat(e.chatUrl),style:{color:"white"}},m.a.createElement("div",{className:"chat_list "},m.a.createElement("div",{className:"chat_people"},m.a.createElement("div",{className:"chat_img"}," ",m.a.createElement("img",{src:"https://ptetutorials.com/images/user-profile.png",alt:"sunil"})," "),m.a.createElement("div",{className:"chat_ib"},m.a.createElement("h5",null,(t=e.name).charAt(0).toUpperCase()+t.slice(1)," ",m.a.createElement("span",{className:"chat_date"},"Dec 25"))))));var t},f=function(e){function t(){var e,a;Object(n.a)(this,t);for(var s=arguments.length,i=new Array(s),r=0;r<s;r++)i[r]=arguments[r];return(a=Object(c.a)(this,(e=Object(o.a)(t)).call.apply(e,[this].concat(i)))).state={chats:[]},a.getUserChats=function(e,t){d.a.defaults.headers={"Content-Type":"application.json",Authorization:"Token ".concat(e)},d.a.get("http://127.0.0.1:8000/api/chat/?username=".concat(t)).then(function(e){a.setState({chats:e.data})})},a}return Object(r.a)(t,e),Object(i.a)(t,[{key:"componentDidMount",value:function(){console.log(this.state.chats),null!==this.props.token&&null!==this.props.username&&this.getUserChats(this.props.token,this.props.username)}},{key:"componentWillReceiveProps",value:function(e){null!==e.token&&null!==e.username&&this.getUserChats(e.token,e.username)}},{key:"render",value:function(){var e=this,t=this.state.chats.map(function(t){return t.participants.map(function(a){if(a.user!==+e.props.userId)return m.a.createElement(g,{key:a.user,name:a.username,status:"online",picUrl:"http://emilcarlsson.se/assets/louislitt.png",chatUrl:"/messages/".concat(t.id)})})});return m.a.createElement("div",{className:"inbox_people"},m.a.createElement("div",{className:"headind_srch"},m.a.createElement("div",{className:"recent_heading"},m.a.createElement("h4",null,"Recent")),m.a.createElement("div",{className:"srch_bar"},m.a.createElement("div",{className:"stylish-input-group"},m.a.createElement("input",{type:"text",className:"search-bar",placeholder:"Search"}),m.a.createElement("span",{className:"input-group-addon"},m.a.createElement("button",{type:"button"}," ",m.a.createElement("i",{className:"fa fa-search","aria-hidden":"true"})," "))," "))),m.a.createElement("div",{className:"inbox_chat"},t))}}]),t}(m.a.Component),v=Object(u.b)(function(e){return{userId:e.authReducer.userId,username:e.authReducer.username,token:e.authReducer.token}})(f),k=a(8),b=function(){function e(){Object(n.a)(this,e),this.callbacks={},this.socketRef=null}return Object(i.a)(e,null,[{key:"getInstance",value:function(){return e.instance||(e.instance=new e),e.instance}}]),Object(i.a)(e,[{key:"connect",value:function(e){var t=this,a="ws://127.0.0.1:8000/ws/chat/".concat(e,"/");this.socketRef=new WebSocket(a),this.socketRef.onopen=function(){},this.socketNewMessage(JSON.stringify({command:"fetch_messages"})),this.socketRef.onmessage=function(e){t.socketNewMessage(e.data)},this.socketRef.onerror=function(e){},this.socketRef.onclose=function(){t.connect()}}},{key:"disconnect",value:function(){this.socketRef.close()}},{key:"socketNewMessage",value:function(e){var t=JSON.parse(e),a=t.command;0!==Object.keys(this.callbacks).length&&("messages"===a&&this.callbacks[a](t.messages),"new_message"===a&&this.callbacks[a](t.message))}},{key:"fetchMessages",value:function(e,t){this.sendMessage({command:"fetch_messages",username:e,chatId:t})}},{key:"newChatMessage",value:function(e){this.sendMessage({command:"new_message",from:e.from,message:e.content,chatId:e.chatId})}},{key:"addCallbacks",value:function(e,t){this.callbacks.messages=e,this.callbacks.new_message=t}},{key:"sendMessage",value:function(e){try{this.socketRef.send(JSON.stringify(Object(k.a)({},e)))}catch(t){console.log(t.message)}}},{key:"state",value:function(){return this.socketRef.readyState}},{key:"waitForSocketConnection",value:function(e){var t=this.socketRef,a=this.waitForSocketConnection;setTimeout(function(){1!==t.readyState?a(e):null!=e&&e()},1)}}]),e}();b.instance=null;var y=b.getInstance(),E=function(e){function t(e){var a;return Object(n.a)(this,t),(a=Object(c.a)(this,Object(o.a)(t).call(this,e))).state={message:""},a.scrollToBottom=function(){},a.sendMessageHandler=function(e){e.preventDefault();var t={from:a.props.username,content:a.state.message,chatId:a.props.match.params.id};y.newChatMessage(t),a.setState({message:""})},a.messageChangeHandler=function(e){a.setState({message:e.target.value})},a.renderTimestamp=function(e){var t=Math.round(((new Date).getTime()-new Date(e).getTime())/6e4);return t<60&&t>1?"".concat(t," minutes ago"):t<1440&&t>60?"".concat(Math.round(t/60)," hours ago"):t<44640&&t>1440?"".concat(Math.round(t/60*24)," days ago"):"".concat(new Date(e))},a.renderMessages=function(e){var t=a.props.username;return e.map(function(e,s,n){return m.a.createElement("div",{key:e.id,className:e.author===t?"outgoing_msg":"incoming_msg"},m.a.createElement("div",{className:e.author===t?"sent_msg":"received_msg"},m.a.createElement("p",null,e.content),m.a.createElement("span",{className:"time_date"},a.renderTimestamp(e.timestamp))))})},a.initializeChat(),a}return Object(r.a)(t,e),Object(i.a)(t,[{key:"initializeChat",value:function(){var e=this;this.waitForSocketConnection(function(){y.addCallbacks(e.setMessages.bind(e),e.addMessage.bind(e)),y.fetchMessages(e.props.username,e.props.match.params.id)}),this.props.match.params.id?y.connect(this.props.match.params.id):y.connect(null)}}]),Object(i.a)(t,[{key:"componentWillReceiveProps",value:function(e){var t=this;this.props.match.params.id!==e.match.params.id&&(y.disconnect(),this.waitForSocketConnection(function(){y.fetchMessages(t.props.username,e.match.params.id)}),y.connect(e.match.params.id))}},{key:"componentDidMount",value:function(){this.scrollToBottom()}},{key:"componentWillUnmount",value:function(){y.disconnect(),window.location.reload()}},{key:"componentDidUpdate",value:function(){this.scrollToBottom()}},{key:"waitForSocketConnection",value:function(e){var t=this;setTimeout(function(){1!==y.state()?t.waitForSocketConnection(e):e()},100)}},{key:"addMessage",value:function(e){this.setState({messages:[].concat(Object(s.a)(this.state.messages),[e])})}},{key:"setMessages",value:function(e){this.setState({messages:e.reverse()})}},{key:"render",value:function(){var e=this,t=this.state.messages;return m.a.createElement("div",{className:"Chat-Container"},m.a.createElement("div",{className:"messaging"},m.a.createElement("div",{className:"inbox_msg"},m.a.createElement(v,null),m.a.createElement("div",{className:"mesgs"},m.a.createElement("div",{className:"msg_history"},t&&this.renderMessages(t),m.a.createElement("div",{style:{float:"left",clear:"both"},ref:function(t){e.messagesEnd=t}})),m.a.createElement("div",{className:"type_msg"},m.a.createElement("div",{className:"input_msg_write"},m.a.createElement("input",{type:"text",className:"write_msg",placeholder:"Type a message",onChange:this.messageChangeHandler,value:this.state.message}),m.a.createElement("button",{className:"msg_send_btn",type:"button",onClick:this.sendMessageHandler},m.a.createElement("i",{className:"fas fa-paper-plane","aria-hidden":"true"}))))))))}}]),t}(m.a.Component);t.default=Object(u.b)(function(e){return{username:e.authReducer.username}})(E)}}]);
//# sourceMappingURL=16.e2fb59de.chunk.js.map